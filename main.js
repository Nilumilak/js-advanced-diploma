!function(){"use strict";function e(e,t,s){let i=0;for(let r=0;r<s;r++)for(let r=0;r<s;r++){if(i==e.position)return a(e,r,s,e.character[t]);i++}}function t(e){const t=[];for(const a of e)t.push(a.position);return t}function a(e,t,a,s){const i=[];let r=e.position-s*(a+1),n=2*s;t<s?(r+=s-t,n-=s-t):a-t-1<s&&(n-=s-(a-t-1));for(let t=0;t<=2*s;t++){for(let t=r;t<=r+n;t++)t!=e.position&&i.push(t);r+=a}return i}class s{constructor(){this.boardSize=8,this.tileMap=function(e){const t={};let a=0;for(let s=0;s<e;s++)for(let i=0;i<e;i++)t[a]=0==s&&0==i?"top-left":0==s&&i==e-1?"top-right":s==e-1&&0==i?"bottom-left":s==e-1&&i==e-1?"bottom-right":0==s?"top":s==e-1?"bottom":0==i?"left":i==e-1?"right":"center",a++;return t}(this.boardSize),this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile",`map-tile-${t=e,a=this.tileMap,a[t]}`),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var i="prairie",r="desert",n="arctic",l="mountain";class c{constructor(e,t=0,a=0,s=50,i="generic"){if(this.level=e,this.attack=t,this.defence=a,this.health=s,this.type=i,"Character"===new.target.name)throw Error("Cannot create class Character")}attackTarget(e){const t=Math.max(this.attack-e.defence,.1*this.attack);return e.health-=t,t}}class h{constructor(e,t){if(!(e instanceof c))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class o extends c{constructor(e,t=25,a=25,s=50){super(e,t,a,s,"bowman"),this.maxMoves=2,this.maxRange=2}}class d extends c{constructor(e,t=10,a=10,s=50){super(e,t,a,s,"daemon"),this.maxMoves=1,this.maxRange=4}}class m extends c{constructor(e,t=10,a=40,s=50){super(e,t,a,s,"magician"),this.maxMoves=1,this.maxRange=4}}class u extends c{constructor(e,t=40,a=10,s=50){super(e,t,a,s,"swordsman"),this.maxMoves=4,this.maxRange=1}}class f extends c{constructor(e,t=40,a=10,s=50){super(e,t,a,s,"undead"),this.maxMoves=4,this.maxRange=1}}class g extends c{constructor(e,t=25,a=25,s=50){super(e,t,a,s,"vampire"),this.maxMoves=2,this.maxRange=2}}class C{constructor(){this.characters=new Set}add(e){if(this.characters.has(e))throw new Error(`Character ${e} is already in the team`);this.characters.add(e)}}function v(e,t,a){const s=new C,i=function*(e,t){for(;;){const a=e[Math.floor(Math.random()*e.length)];yield new a(Math.ceil(Math.random()*t))}}(e,t);for(let e=0;e<a;e++)s.add(i.next().value);return s}var L="auto",P="pointer",p="crosshair",T="not-allowed";class y{#e={first:"first",second:"second"};constructor(e=this.#e.first,t=!0,a=0,s=0,i=[],r=[],n=void 0,l=[]){this.turn=e,this.running=t,this.points=a,this.maxPoints=s,this.firstTeamList=i,this.secondTeamList=r,this.currentLevel=n,this.nextLevelsList=l}changeTurn(){this.turn==this.#e.first?this.turn=this.#e.second:this.turn=this.#e.first}getPoint(){this.points++}refreshPoints(){this.points=0}saveMaxPoints(){this.maxPoints=this.points,this.points=0}static from(e){const{turn:t,running:a,points:s,maxPoints:i,firstTeamList:r,secondTeamList:n,currentLevel:l,nextLevelsList:c}=e;return new y(t,a,s,i,r,n,l,c)}}const S=new s;S.bindToDOM(document.querySelector("#game-container"));const w=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),E=new class{#t={bowman:o,daemon:d,magician:m,swordsman:u,undead:f,vampire:g};#a=void 0;#s=[l,n,r];#i=void 0;#r=[5,4,3];constructor(e,t){this.gameState=new y,this.gamePlay=e,this.stateService=t,this.allCharacters={},this.firstTeamAllowedCharacters=[o,u,m],this.secondTeamAllowedCharacters=[d,f,g]}get currentLevel(){return this.#i}get getNextLevelType(){return this.#i=this.#s.pop(),this.#i}get nextLevelsList(){return this.#s}setlevelTypes(e){this.#s=e}refreshLevels(){this.#s=[l,n,r]}get getNextEnemiesAmount(){return this.#r.pop()}refreshEnemies(){this.#r=[5,4,3]}get allCharactersList(){let e=[];for(const t in this.allCharacters)e=e.concat(this.allCharacters[t]);return e}get characterSelected(){return this.#a}set characterSelected(e){this.#a=e}init(){this.startNewGame(),this.setHandlers()}initPositionTeam(e,t){const a=[];for(const i of e.characters){const e=(s=t,s.splice(Math.floor(Math.random()*s.length),1))[0];a.push(new h(i,e))}var s;return a}setHandlers(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.startNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this))}getPositions(){const e=[],t=[];let a=0;for(let s=0;s<this.gamePlay.boardSize;s++)for(let s=0;s<this.gamePlay.boardSize;s++)0!=s&&1!=s||e.push(a),6!=s&&7!=s||t.push(a),a++;return{firstTeamPositionsList:e,secondTeamPositionsList:t}}onCellClick(a){this.gameState.running&&"first"==this.gameState.turn&&(this.cellHasCharacter(a,(s=>{if(t(this.allCharacters.firstTeamPositioned).includes(a)){for(const e of this.allCharactersList)this.gamePlay.deselectCell(e.position);this.gamePlay.selectCell(a),this.characterSelected=s}else if(t(this.allCharacters.secondTeamPositioned).includes(a)&&this.characterSelected&&e(this.characterSelected,"maxRange",this.gamePlay.boardSize).includes(a)){this.gameState.changeTurn();const e=this.characterSelected.character.attackTarget(s.character);this.deleteDeadCharacters(),this.gamePlay.redrawPositions(this.allCharactersList),this.gamePlay.showDamage(a,e).then((()=>this.enemyTurn()))}}))||(this.characterSelected?e(this.characterSelected,"maxMoves",this.gamePlay.boardSize).includes(a)&&(this.gamePlay.deselectCell(this.characterSelected.position),this.characterSelected.position=a,this.gamePlay.selectCell(a),this.gamePlay.redrawPositions(this.allCharactersList),this.gameState.changeTurn(),this.enemyTurn()):s.showError("Empty cell")))}characterTag(e){return`🎖${e.level} ⚔${e.attack} 🛡${e.defence} ❤${e.health}`}cellHasCharacter(e,t,a=this.allCharactersList){for(const s of a)if(s.position==e)return t(s),!0;return!1}onCellEnter(a){this.cellHasCharacter(a,(t=>{this.gamePlay.showCellTooltip(this.characterTag(t.character),a),this.allCharacters.firstTeamPositioned.includes(t)?this.gamePlay.setCursor(P):this.characterSelected&&this.allCharacters.secondTeamPositioned.includes(t)&&(e(this.characterSelected,"maxRange",this.gamePlay.boardSize).includes(t.position)?(this.gamePlay.setCursor(p),this.gamePlay.selectCell(a,"red")):this.gamePlay.setCursor(T))})),this.characterSelected&&e(this.characterSelected,"maxMoves",this.gamePlay.boardSize).includes(a)&&!t(this.allCharactersList).includes(a)&&this.gamePlay.selectCell(a,"green")}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(L);for(let t=0;t<this.gamePlay.boardSize;t++)for(let t=0;t<this.gamePlay.boardSize;t++)this.characterSelected&&e!=this.characterSelected.position&&this.gamePlay.deselectCell(e)}enemyTurn(){for(const t of this.allCharacters.secondTeamPositioned){const a=e(t,"maxRange",this.gamePlay.boardSize);if("second"==this.gameState.turn)for(const e of a)if(this.cellHasCharacter(e,(a=>{if(this.allCharacters.firstTeamPositioned.includes(a)){const s=t.character.attackTarget(a.character);this.deleteDeadCharacters(),this.gamePlay.redrawPositions(this.allCharactersList),this.gamePlay.showDamage(e,s),this.gameState.changeTurn()}}),this.allCharacters.firstTeamPositioned))return void("second"==this.gameState.turn&&this.gameState.changeTurn())}this.gameState.changeTurn()}deleteDeadCharacters(){for(const e of this.allCharactersList)if(e.character.health<=0){let t=this.allCharacters.firstTeamPositioned.indexOf(e);t>-1?(this.allCharacters.firstTeamPositioned.splice(this.allCharacters.firstTeamPositioned.indexOf(e),1),e==this.characterSelected&&(this.gamePlay.deselectCell(this.characterSelected.position),this.characterSelected=void 0)):(t=this.allCharacters.secondTeamPositioned.indexOf(e),t>-1&&(this.allCharacters.secondTeamPositioned.splice(this.allCharacters.secondTeamPositioned.indexOf(e),1),this.gameState.getPoint()))}this.allCharacters.firstTeamPositioned.length||this.finishGame(),this.allCharacters.secondTeamPositioned.length||(this.levelUpCharacters(this.allCharacters.firstTeamPositioned),this.startNextLevel())}startNextLevel(){this.characterSelected=void 0;const e=this.getNextLevelType;if(e){this.gamePlay.drawUi(e);const t=v(this.firstTeamAllowedCharacters,4,1);this.allCharacters.firstTeamPositioned.forEach((e=>t.characters.add(e.character)));const a=v(this.secondTeamAllowedCharacters,4,this.getNextEnemiesAmount),s=this.getPositions(),i=this.initPositionTeam(t,s.firstTeamPositionsList),r=this.initPositionTeam(a,s.secondTeamPositionsList);this.allCharacters.firstTeamPositioned=i,this.allCharacters.secondTeamPositioned=r,this.gamePlay.redrawPositions(this.allCharactersList)}else this.finishGame()}levelUpCharacters(e){for(const t of e)t.character.attack=Math.max(t.character.attack,t.character.attack*((80+t.character.health)/100)),t.character.defence=Math.max(t.character.defence,t.character.defence*((80+t.character.health)/100)),t.character.health=Math.min(100,t.character.health+80)}finishGame(){this.gameState.running=!1;let e=0;for(let t=0;t<this.gamePlay.boardSize;t++)for(let t=0;t<this.gamePlay.boardSize;t++)this.gamePlay.deselectCell(e),e++;this.gameState.saveMaxPoints()}startNewGame(){this.gameState.running=!0,this.refreshLevels(),this.refreshEnemies(),this.gameState.refreshPoints(),this.gamePlay.drawUi(i),this.#i=i;const e=v(this.firstTeamAllowedCharacters,4,2),t=v(this.secondTeamAllowedCharacters,4,2),a=this.getPositions(),s=this.initPositionTeam(e,a.firstTeamPositionsList),r=this.initPositionTeam(t,a.secondTeamPositionsList);this.allCharacters.firstTeamPositioned=s,this.allCharacters.secondTeamPositioned=r,this.gamePlay.redrawPositions(this.allCharactersList)}saveGame(){this.gameState.firstTeamList=this.allCharacters.firstTeamPositioned,this.gameState.secondTeamList=this.allCharacters.secondTeamPositioned,this.gameState.currentLevel=this.currentLevel,this.gameState.nextLevelsList=this.nextLevelsList,this.stateService.save(this.gameState)}loadGame(){try{const e=this.stateService.load();this.gameState=y.from(e),this.characterSelected=void 0;const t=this.gameState.currentLevel;this.#i=t,this.setlevelTypes(this.gameState.nextLevelsList),this.gamePlay.drawUi(t),this.allCharacters.firstTeamPositioned=this.gameState.firstTeamList.map((e=>this.createCharacterFromData(e))),this.allCharacters.secondTeamPositioned=this.gameState.secondTeamList.map((e=>this.createCharacterFromData(e))),this.gamePlay.redrawPositions(this.allCharactersList)}catch{s.showError("Cannot find saved data")}}createCharacterFromData(e){if(Object.keys(this.#t).includes(e.character.type)){const t=new this.#t[e.character.type](e.character.level,e.character.attack,e.character.defence,e.character.health);return new h(t,e.position)}}}(S,w);E.init()}();